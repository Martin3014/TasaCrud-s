const controller = {};

// Lista de las tasas de cambio

controller.list = (req, res) => {
  req.getConnection((err, conn) => {
    conn.query('SELECT * FROM Tasa', (err, tasa) =>{
        if(err){
            console.error(err); 
            return res.status(500).send('Error al obtener datos de la base de datos');
        }
       tasa.forEach(element => {
           console.log(element.id);
        });
        res.render('tasa', {
            data: tasa
        });
    });
  });
};

// Agregar una tasa de cambio

controller.save = (req, res) => {
    const data = req.body;

        data.colones = parseFloat(data.colones);
        data.usd = data.colones * 0.00188858;

    req.getConnection((err, conn) => {
        conn.query('INSERT INTO Tasa SET ?', [data], (err, rows) =>{
            if (err) {
                console.log(err);
                res.send('Error al guardar la tasa.');
             } else {
        //        console.log(rows);
                res.redirect('/');
            }
        });
    });
};

// Eliminar una tasa de cambio

controller.delete = (req, res) => {
    const { id} = req.params;

    req.getConnection((err, conn) =>{
        conn.query('DELETE FROM Tasa WHERE id = ? ', [id], (err, rows)=>{
            res.redirect('/');
        })
    });
};

// Actualizar una tasa de cambio

 controller.update = (req, res) => {
        const { id } = req.params;

        req.getConnection((err, conn) =>{
            conn.query('SELECT * FROM Tasa WHERE id= ?', [id], (err, rows) =>{
                if (err) {
                    console.log(err);
                    res.redirect('/error');
                }else{
                    res.render('updateTasaView', {
                        data: rows[0]
                    });
                };
            });
        });
    };

// Actualizar los datos de una tasa de cambio
controller.updateDatos = (req, res) => {
    const { id } = req.params;
    const newTasa = req.body;

    newTasa.colones = parseFloat(newTasa.colones);
    newTasa.usd = newTasa.colones * 0.00188858;

    req.getConnection((err, conn) =>{
        conn.query('UPDATE Tasa SET ? WHERE id = ?', [newTasa, id], (err, rows) =>{
            if (err) {
                console.log(err);
                res.redirect('/error');
            }else{
                res.redirect('/');
            };
        });
    });
};


//Funci√≥n para obtener la tasa de cambio actual desde una API
async function tasaDesdeAPI() {
    try {  
        const response = await fetch('https://api.hacienda.go.cr/indicadores/tc/dolar');

        if (!response.ok) {
            throw new Error('No se pudo obtener la tasa de cambio desde la API');
        } 

        const data = await response.json();
        const tasaDeCambio = data.tasa;

        return tasaDeCambio;

    } catch (error) {
        console.error('Error al obtener la tasa de cambio desde la API:', error);
        throw error;
    }
}

module.exports = controller;